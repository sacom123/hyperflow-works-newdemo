name: Trigger GitLab Pipeline on Push

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    env:
      GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID }}
      GITLAB_URL: ${{ secrets.GITLAB_URL }}
    steps:
      - name: Trigger GitLab pipeline
        run: |
          set -euo pipefail
          URL="${GITLAB_URL:-}"
          if [ -z "$URL" ] && [ -n "${GITLAB_PROJECT_ID:-}" ]; then
            URL="https://gitlab.com/api/v4/projects/${GITLAB_PROJECT_ID}/ref/main/trigger/pipeline"
          fi
          if [ -z "$URL" ]; then
            echo "Missing GITLAB_URL or GITLAB_PROJECT_ID secret."
            exit 1
          fi
          curl -sS -X POST "$URL" \
            --form token=${{ secrets.GITLAB_TRIGGER_TOKEN }} \
            --form ref=main \
            --form "variables[GH_SHA]=${{ github.sha }}" \
            --form "variables[GH_REPO]=${{ github.repository }}" \
            --form "variables[GH_ACTOR]=${{ github.actor }}"

