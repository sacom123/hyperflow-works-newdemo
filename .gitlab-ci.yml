stages:
  - build
  - deploy

variables:
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  GAR_HOST: "$GCP_REGION-docker.pkg.dev"
  FRONTEND_IMAGE: "$GAR_HOST/$GCP_PROJECT_ID/$AR_REPO/frontend:$IMAGE_TAG"
  BACKEND_IMAGE: "$GAR_HOST/$GCP_PROJECT_ID/$AR_REPO/backend:$IMAGE_TAG"

.default_gcloud:
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  before_script:
    # Authenticate via WIF (OIDC) using GitLab issued id_token
    # Required GitLab CI/CD variables:
    # - WIF_PROVIDER_RESOURCE: projects/<PROJECT_NUMBER>/locations/global/workloadIdentityPools/<POOL_ID>/providers/<PROVIDER_ID>
    # - WIF_SERVICE_ACCOUNT: <sa>@<project>.iam.gserviceaccount.com
    - |
      if [[ -z "${WIF_PROVIDER_RESOURCE:-}" || -z "${WIF_SERVICE_ACCOUNT:-}" ]]; then
        echo "Missing WIF_PROVIDER_RESOURCE or WIF_SERVICE_ACCOUNT variables." >&2
        exit 1
      fi
      if [[ -z "${GCP_ID_TOKEN:-}" ]]; then
        echo "Missing OIDC id_token (GCP_ID_TOKEN). Ensure 'id_tokens' is configured for this job." >&2
        exit 1
      fi
      # Write the OIDC token to a file for external_account credential_source
      printf "%s" "$GCP_ID_TOKEN" > /tmp/gitlab-oidc-token
      cat > wif_config.json <<EOF
      {
        "type": "external_account",
        "audience": "//iam.googleapis.com/${WIF_PROVIDER_RESOURCE}",
        "subject_token_type": "urn:ietf:params:oauth:token-type:id_token",
        "token_url": "https://sts.googleapis.com/v1/token",
        "service_account_impersonation_url": "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/${WIF_SERVICE_ACCOUNT}:generateAccessToken",
        "credential_source": {
          "file": "/tmp/gitlab-oidc-token",
          "format": { "type": "text" }
        }
      }
      EOF
      gcloud auth login --cred-file=./wif_config.json
    - gcloud config set project "$GCP_PROJECT_ID"
    - gcloud auth configure-docker "$GAR_HOST" --quiet
    # Normalize repo/image variables to avoid empty repo (//) errors
    - |
      EFFECTIVE_AR_REPO="${AR_REPO:-$GAR_REPO}"
      if [[ -z "${EFFECTIVE_AR_REPO:-}" ]]; then
        echo "AR_REPO (or GAR_REPO) is required but not set." >&2
        exit 1
      fi
      export FRONTEND_IMAGE="$GAR_HOST/$GCP_PROJECT_ID/$EFFECTIVE_AR_REPO/frontend:$IMAGE_TAG"
      export BACKEND_IMAGE="$GAR_HOST/$GCP_PROJECT_ID/$EFFECTIVE_AR_REPO/backend:$IMAGE_TAG"

build_frontend_image:
  stage: build
  extends: .default_gcloud
  id_tokens:
    GCP_ID_TOKEN:
      aud: //iam.googleapis.com/${WIF_PROVIDER_RESOURCE}
  script:
    - |
      BUILD_ID="$(gcloud builds submit ./frontend --tag "$FRONTEND_IMAGE" --format='value(name)' --async)"
      echo "Submitted Cloud Build: ${BUILD_ID}"
      # Poll for completion without streaming logs (avoids VPC-SC/logs bucket streaming issues)
      for i in $(seq 1 300); do
        STATUS="$(gcloud builds describe "${BUILD_ID}" --format='value(status)' || true)"
        echo "Build status: ${STATUS}"
        if [[ "${STATUS}" == "SUCCESS" ]]; then
          break
        elif [[ "${STATUS}" == "FAILURE" || "${STATUS}" == "CANCELLED" || "${STATUS}" == "TIMEOUT" ]]; then
          echo "Cloud Build ended with status: ${STATUS}"
          exit 1
        fi
        sleep 2
      done
      if [[ "${STATUS:-}" != "SUCCESS" ]]; then
        echo "Cloud Build did not reach SUCCESS within timeout."
        exit 1
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

build_backend_image:
  stage: build
  extends: .default_gcloud
  id_tokens:
    GCP_ID_TOKEN:
      aud: //iam.googleapis.com/${WIF_PROVIDER_RESOURCE}
  script:
    - |
      BUILD_ID="$(gcloud builds submit ./backend --tag "$BACKEND_IMAGE" --format='value(name)' --async)"
      echo "Submitted Cloud Build: ${BUILD_ID}"
      # Poll for completion without streaming logs (avoids VPC-SC/logs bucket streaming issues)
      for i in $(seq 1 300); do
        STATUS="$(gcloud builds describe "${BUILD_ID}" --format='value(status)' || true)"
        echo "Build status: ${STATUS}"
        if [[ "${STATUS}" == "SUCCESS" ]]; then
          break
        elif [[ "${STATUS}" == "FAILURE" || "${STATUS}" == "CANCELLED" || "${STATUS}" == "TIMEOUT" ]]; then
          echo "Cloud Build ended with status: ${STATUS}"
          exit 1
        fi
        sleep 2
      done
      if [[ "${STATUS:-}" != "SUCCESS" ]]; then
        echo "Cloud Build did not reach SUCCESS within timeout."
        exit 1
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

deploy_frontend:
  stage: deploy
  extends: .default_gcloud
  needs: [ "build_frontend_image" ]
  id_tokens:
    GCP_ID_TOKEN:
      aud: //iam.googleapis.com/${WIF_PROVIDER_RESOURCE}
  script:
    - gcloud run deploy "$FRONTEND_SERVICE" \
        --image "$FRONTEND_IMAGE" \
        --region "$GCP_REGION" \
        --platform managed \
        --allow-unauthenticated \
        --port 8080
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success

deploy_backend:
  stage: deploy
  extends: .default_gcloud
  needs: [ "build_backend_image" ]
  id_tokens:
    GCP_ID_TOKEN:
      aud: //iam.googleapis.com/${WIF_PROVIDER_RESOURCE}
  script:
    - gcloud run deploy "$BACKEND_SERVICE" \
        --image "$BACKEND_IMAGE" \
        --region "$GCP_REGION" \
        --platform managed \
        --allow-unauthenticated \
        --port 3000
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success

