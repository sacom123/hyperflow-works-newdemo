stages:
  - build
  - deploy

variables:
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  GAR_HOST: "$GCP_REGION-docker.pkg.dev"
  FRONTEND_IMAGE: "$GAR_HOST/$GCP_PROJECT_ID/$GAR_REPO/frontend:$IMAGE_TAG"
  BACKEND_IMAGE: "$GAR_HOST/$GCP_PROJECT_ID/$GAR_REPO/backend:$IMAGE_TAG"

.default_gcloud:
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  before_script:
    # Authenticate via WIF (OIDC) using GitLab issued id_token
    # Required GitLab CI/CD variables:
    # - WIF_PROVIDER: projects/<PROJECT_NUMBER>/locations/global/workloadIdentityPools/<POOL_ID>/providers/<PROVIDER_ID>
    # - WIF_SERVICE_ACCOUNT: <sa>@<project>.iam.gserviceaccount.com
    - |
      if [[ -z "${WIF_PROVIDER:-}" || -z "${WIF_SERVICE_ACCOUNT:-}" ]]; then
        echo "Missing WIF_PROVIDER or WIF_SERVICE_ACCOUNT variables." >&2
        exit 1
      fi
      cat > wif_config.json <<EOF
      {
        "type": "external_account",
        "audience": "//iam.googleapis.com/${WIF_PROVIDER}",
        "subject_token_type": "urn:ietf:params:oauth:token-type:id_token",
        "token_url": "https://sts.googleapis.com/v1/token",
        "service_account_impersonation_url": "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/${WIF_SERVICE_ACCOUNT}:generateAccessToken",
        "credential_source": { "environment_id_token": "GCP_ID_TOKEN" }
      }
      EOF
      gcloud auth login --cred-file=./wif_config.json
    - gcloud config set project "$GCP_PROJECT_ID"
    - gcloud auth configure-docker "$GAR_HOST" --quiet

build_frontend_image:
  stage: build
  extends: .default_gcloud
  id_tokens:
    GCP_ID_TOKEN:
      aud: https://iam.googleapis.com
  script:
    - gcloud builds submit ./frontend --tag "$FRONTEND_IMAGE"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

build_backend_image:
  stage: build
  extends: .default_gcloud
  id_tokens:
    GCP_ID_TOKEN:
      aud: https://iam.googleapis.com
  script:
    - gcloud builds submit ./backend --tag "$BACKEND_IMAGE"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

deploy_frontend:
  stage: deploy
  extends: .default_gcloud
  needs: [ "build_frontend_image" ]
  id_tokens:
    GCP_ID_TOKEN:
      aud: https://iam.googleapis.com
  script:
    - gcloud run deploy "$FRONTEND_SERVICE" \
        --image "$FRONTEND_IMAGE" \
        --region "$GCP_REGION" \
        --platform managed \
        --allow-unauthenticated \
        --port 8080
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success

deploy_backend:
  stage: deploy
  extends: .default_gcloud
  needs: [ "build_backend_image" ]
  id_tokens:
    GCP_ID_TOKEN:
      aud: https://iam.googleapis.com
  script:
    - gcloud run deploy "$BACKEND_SERVICE" \
        --image "$BACKEND_IMAGE" \
        --region "$GCP_REGION" \
        --platform managed \
        --allow-unauthenticated \
        --port 3000
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success

