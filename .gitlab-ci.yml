stages:
  - build
  - deploy

variables:
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  GAR_HOST: "$GCP_REGION-docker.pkg.dev"
  FRONTEND_IMAGE: "$GAR_HOST/$GCP_PROJECT_ID/$GAR_REPO/frontend:$IMAGE_TAG"
  BACKEND_IMAGE: "$GAR_HOST/$GCP_PROJECT_ID/$GAR_REPO/backend:$IMAGE_TAG"

.default_gcloud:
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  before_script:
    # Authenticate (Service Account key expected as a masked CI/CD file variable)
    - |
      if [[ -n "${GCP_SA_KEY:-}" ]]; then
        echo "Using Service Account key for auth"
        gcloud auth activate-service-account --key-file "$GCP_SA_KEY"
      else
        echo "GCP_SA_KEY file variable is missing. Add it in GitLab CI/CD Variables." >&2
        exit 1
      fi
    - gcloud config set project "$GCP_PROJECT_ID"
    - gcloud auth configure-docker "$GAR_HOST" --quiet

build_frontend_image:
  stage: build
  extends: .default_gcloud
  script:
    - gcloud builds submit ./frontend --tag "$FRONTEND_IMAGE"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

build_backend_image:
  stage: build
  extends: .default_gcloud
  script:
    - gcloud builds submit ./backend --tag "$BACKEND_IMAGE"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

deploy_frontend:
  stage: deploy
  extends: .default_gcloud
  needs: [ "build_frontend_image" ]
  script:
    - gcloud run deploy "$FRONTEND_SERVICE" \
        --image "$FRONTEND_IMAGE" \
        --region "$GCP_REGION" \
        --platform managed \
        --allow-unauthenticated \
        --port 8080
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success

deploy_backend:
  stage: deploy
  extends: .default_gcloud
  needs: [ "build_backend_image" ]
  script:
    - gcloud run deploy "$BACKEND_SERVICE" \
        --image "$BACKEND_IMAGE" \
        --region "$GCP_REGION" \
        --platform managed \
        --allow-unauthenticated \
        --port 3000
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success

